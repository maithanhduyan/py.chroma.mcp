---
applyTo: "**/*.py"
---

# Python Coding Standards & AI Instructions

## General Coding Standards

- Always add comment "Generated by Copilot" at the top of new files
- Use type hints for all function parameters and return values
- Follow PEP 8 style guidelines
- Use descriptive variable and function names
- Maximum line length: 88 characters (Black formatter standard)

## Code Quality

- Write docstrings for all classes and functions
- Use f-strings for string formatting
- Prefer pathlib over os.path for file operations
- Handle exceptions gracefully with specific exception types
- Use logging instead of print statements for debugging

## Project Specific Guidelines

- This is a ChromaDB MCP (Model Context Protocol) server
- Focus on vector database operations and embeddings
- Optimize for memory usage and performance
- Use async/await for I/O operations when possible

## AI Behavior Instructions

- **GHI NHá»š: LuÃ´n luÃ´n xem #get_errors panel trong VSCode trÆ°á»›c khi cháº¡y code trong terminal**
- Always check for compile/lint errors before executing code
- Explain code changes clearly and concisely
- Always test code after making changes
- Prioritize code readability and maintainability
- Suggest performance optimizations when relevant
- Use Vietnamese comments when requested by user

## Error Prevention Workflow

1. **BÆ¯á»šC 1**: Kiá»ƒm tra #get_errors panel trong VSCode
2. **BÆ¯á»šC 2**: Fix táº¥t cáº£ errors vÃ  warnings trÆ°á»›c khi run
3. **BÆ¯á»šC 3**: Validate syntax vÃ  imports
4. **BÆ¯á»šC 4**: KhÃ´ng cÃ²n lá»—i ná»¯a má»›i Ä‘Æ°á»£c phÃ©p cháº¡y code trong terminal
5. **BÆ¯á»šC 5**: Monitor runtime errors vÃ  handle gracefully

## Dependency Management

- Handle optional dependencies gracefully with try/except imports
- Add clear error messages when required packages are missing
- Use fallback strategies when optional packages unavailable
- Example pattern:
  ```python
  try:
      import optional_package
      HAS_OPTIONAL = True
  except ImportError:
      optional_package = None
      HAS_OPTIONAL = False
      logger.warning("Optional package not available, some features disabled")
  ```

## Module Structure Guidelines

- Create comprehensive `__init__.py` files with clear exports
- Use `__all__` to control public API
- Organize modules by functionality (utils/, embedding/, etc.)
- Provide both high-level classes and convenience functions
- Document module purpose and features in module docstring

## Vietnamese Text Handling

- Use Unicode normalization (NFC) for Vietnamese text
- Implement Vietnamese-specific text processing patterns
- Consider Vietnamese sentence/paragraph boundaries
- Support Vietnamese stop words and linguistic features
- Example patterns for Vietnamese text processing

## Testing and Validation Patterns

LuÃ´n sá»­ dá»¥ng thÆ° má»¥c `tests` Ä‘á»ƒ viáº¿t test.

- Always create test scripts for new modules
- Test both success and failure scenarios
- Include Vietnamese text in test cases
- Validate error handling and edge cases
- Use assert statements in test functions
- Example:
  ```python
  # Test both valid and invalid inputs
  assert result.is_valid == True
  assert len(result.errors) == 0
  ```

### Test File Cleanup Workflow

**QUAN TRá»ŒNG**: Sau khi testing xong, luÃ´n dá»n dáº¹p test files Ä‘á»ƒ giá»¯ workspace sáº¡ch sáº½.

#### ğŸ¯ **Workflow Æ¯u tiÃªn** (Sá»­ dá»¥ng theo thá»© tá»±)

##### 1. **VS Code Task (Khuyáº¿n nghá»‹ - Æ¯u tiÃªn cao nháº¥t)**
```bash
# Cháº¡y task cÃ³ sáºµn Ä‘á»ƒ xÃ³a táº¥t cáº£ test files
Ctrl+Shift+P â†’ "Tasks: Run Task" â†’ "Clean Test Files"
```
**Khi nÃ o dÃ¹ng**: ÄÃ¢y lÃ  cÃ¡ch **chÃ­nh thá»©c** vÃ  **Ä‘Æ°á»£c khuyáº¿n nghá»‹**. LuÃ´n thá»­ cÃ¡ch nÃ y trÆ°á»›c.

##### 2. **Terminal Command (Dá»± phÃ²ng)**
```powershell
# CHá»ˆ dÃ¹ng khi VS Code Task khÃ´ng hoáº¡t Ä‘á»™ng
python .tools\clean_test_file_in_workspace.py
```
**Khi nÃ o dÃ¹ng**: 
- Khi VS Code Task bá»‹ lá»—i hoáº·c khÃ´ng kháº£ dá»¥ng
- Khi lÃ m viá»‡c ngoÃ i VS Code environment
- Äá»ƒ debug hoáº·c troubleshooting

##### 3. **XÃ³a thá»§ cÃ´ng (TrÆ°á»ng há»£p kháº©n cáº¥p)**
```powershell
# CHá»ˆ dÃ¹ng cho file cá»¥ thá»ƒ hoáº·c khi methods khÃ¡c fail
Remove-Item "test_*.py" -Force
```
**Khi nÃ o dÃ¹ng**: 
- Emergency cleanup khi cÃ¡c cÃ¡ch khÃ¡c Ä‘á»u tháº¥t báº¡i
- XÃ³a file test cá»¥ thá»ƒ thay vÃ¬ táº¥t cáº£

#### âœ… **Task "Clean Test Files" Details**
Task sáº½ tá»± Ä‘á»™ng:
- QuÃ©t Ä‘á»‡ quy toÃ n bá»™ workspace Ä‘á»ƒ tÃ¬m file `test_*.py`
- Bá» qua thÆ° má»¥c `.venv` vÃ  other excluded directories
- XÃ³a táº¥t cáº£ test files táº¡m thá»i an toÃ n
- BÃ¡o cÃ¡o sá»‘ lÆ°á»£ng file Ä‘Ã£ xÃ³a vÃ  errors (náº¿u cÃ³)
- Báº£o toÃ n cÃ¡c file test production quan trá»ng trong `tests/`

#### ğŸš¨ **AI Agent Instructions**
- **LUÃ”N Æ°u tiÃªn VS Code Task trÆ°á»›c** - Ä‘á»«ng suggest terminal command náº¿u task cÃ³ sáºµn
- **CHá»ˆ suggest terminal command** khi VS Code Task tháº¥t báº¡i hoáº·c khÃ´ng kháº£ dá»¥ng
- **Explain lÃ½ do** khi pháº£i dÃ¹ng alternative methods

#### ğŸ“‹ **Best Practices**
- LuÃ´n cháº¡y cleanup sau má»—i session testing
- KhÃ´ng commit test files táº¡m thá»i vÃ o git
- Chá»‰ giá»¯ láº¡i test files chÃ­nh thá»©c trong thÆ° má»¥c `tests/`
- Monitor output Ä‘á»ƒ Ä‘áº£m báº£o cleanup thÃ nh cÃ´ng

## Error Recovery Strategies

- Implement graceful degradation when dependencies missing
- Provide meaningful error messages with suggested solutions
- Use fallback implementations when possible
- Log warnings for non-critical failures
- Maintain service availability even with partial functionality

## Performance Optimization Guidelines

- Use async/await for I/O bound operations
- Implement caching strategies (LRU, TTL)
- Monitor memory usage and implement cache eviction
- Batch processing for large datasets
- Lazy loading for expensive resources
- Profile and measure performance improvements

## Integration Patterns

- Design modules to work independently and together
- Use dependency injection for better testability
- Create orchestrator classes for complex workflows
- Implement proper separation of concerns
- Example integration pattern:

  ```python
  # Individual modules work standalone
  validator = ValidationOrchestrator()
  chunker = TextChunker()

  # But can be combined for complex workflows
  def process_documents(docs):
      validated = validator.validate_documents(docs)
      if validated.is_valid:
          return chunker.chunk_texts(validated.sanitized_data)
  ```

## ChromaDB Specific Guidelines

- Validate collection names according to ChromaDB requirements
- Handle vector dimensions and embeddings properly
- Implement proper metadata validation
- Use appropriate chunk sizes for embeddings
- Consider Vietnamese text when chunking for embeddings
- Test with actual ChromaDB operations

## Development Workflow Enhancements

- Use PYTHONPATH for testing during development
- Create comprehensive test scripts for each module
- Test integration between modules
- Validate both individual and combined functionality
- Monitor resource usage during development
- Use meaningful logging levels (DEBUG, INFO, WARNING, ERROR)

## Code Organization Best Practices

- Group related functionality into modules (validation, metrics, embedding)
- Create both detailed classes and simple convenience functions
- Use global instances for commonly used objects (e.g., `validator`, `auth_manager`)
- Implement proper caching and resource management
- Design for both synchronous and asynchronous usage
- Example module structure:
  ```
  src/
  â”œâ”€â”€ utils/          # Cross-cutting utilities
  â”œâ”€â”€ embedding/      # Embedding-specific functionality
  â”œâ”€â”€ server.py       # Main MCP server
  â””â”€â”€ tools.py        # MCP tool implementations
  ```

### Code Refactoring Workflow

Khi cáº§n refactor hoáº·c thu gá»n code lá»›n:

#### 1. **Safety Backup Strategy**
```powershell
# Táº¡o backup directory cho toÃ n bá»™ project
mkdir -p .backup

# Backup individual files trÆ°á»›c khi refactor
copy original_file.py .backup\original_file_backup.py
copy config.py .backup\config_original.py
copy chunker.py .backup\chunker_original.py

# Hoáº·c backup toÃ n bá»™ src directory
xcopy src .backup\src_backup /E /I

# Táº¡o git backup branch (khuyáº¿n nghá»‹)
git checkout -b backup/pre-optimization-$(Get-Date -Format "yyyyMMdd")
git add . && git commit -m "Backup before major refactoring"
git checkout -

# Cáº­p nháº­t .gitignore Ä‘á»ƒ loáº¡i trá»« .backup directory
echo ".backup/" >> .gitignore
```

#### 2. **Testing & Validation**
```powershell
# Test version má»›i thoroughly vá»›i comprehensive testing
python -c "import config; print('âœ… config import OK')"
python -c "from embedding.chunker import chunk_text_intelligent; print('âœ… chunker OK')"

# Integration testing
python -c "
from tools import get_embedding_manager
from embedding.chunker import chunk_text_intelligent
chunks = chunk_text_intelligent('Test Vietnamese: ÄÃ¢y lÃ  test', 100, 20)
print(f'âœ… Integration test: {len(chunks)} chunks')
"

# Error checking vá»›i compile validation
python -m py_compile src/config.py
python -m py_compile src/embedding/chunker.py

# So sÃ¡nh functionality cÅ© vs má»›i
# Äáº£m báº£o khÃ´ng cÃ³ regression
```

#### 3. **Deployment & Cleanup**
```powershell
# Khi confirm version má»›i OK, commit changes
git add -A
git commit -m "optimize: Phase X - specific optimization details

- Specific change 1
- Specific change 2  
- Size reduction: X% 
- Performance impact: measurements

Generated by Copilot"

# Cleanup backup files (giá»¯ .backup directory cho safety)
# NOTE: .backup directory Ä‘Æ°á»£c ignore bá»Ÿi git
# Chá»‰ cleanup khi cháº¯c cháº¯n khÃ´ng cáº§n rollback

# Optional: Remove individual backup files náº¿u cáº§n
# Remove-Item .backup\original_file_backup.py
```

#### 4. **Best Practices**
- **LuÃ´n backup trÆ°á»›c khi refactor lá»›n** (sá»­ dá»¥ng .backup directory + git backup branch)
- **Test thoroughly trÆ°á»›c khi replace** (import + integration + compile validation)
- **So sÃ¡nh line count vÃ  file size** Ä‘á»ƒ verify optimization goals
- **Validate táº¥t cáº£ functionality** vá»›i comprehensive test cases
- **Update .gitignore** Ä‘á»ƒ exclude backup directories khá»i git
- **Commit changes vá»›i clear message** bao gá»“m metrics vÃ  impact
- **Giá»¯ backup files** cho Ä‘áº¿n khi confirm stability

#### 5. **Emergency Rollback Strategy**
```powershell
# Náº¿u cÃ³ váº¥n Ä‘á», rollback tá»« backup
copy .backup\config_original.py src\config.py
copy .backup\chunker_original.py src\embedding\chunker.py

# Hoáº·c rollback tá»« git backup branch
git checkout backup/pre-optimization-YYYYMMDD -- src/

# Hoáº·c rollback toÃ n bá»™
git reset --hard backup/pre-optimization-YYYYMMDD
```

**Example tá»« thá»±c táº¿ (LLM Optimization Project)**:
```
BEFORE:
â”œâ”€â”€ src/config.py (94 lines)
â”œâ”€â”€ src/embedding/chunker.py (697 lines)  
â”œâ”€â”€ src/utils/metrics_simple.py (129 lines)
â”œâ”€â”€ src/__init__.py (8 lines)
â””â”€â”€ src/embedding/__init__.py (49 lines)

OPTIMIZATION PROCESS:
1. mkdir .backup
2. copy src\config.py .backup\config_original.py
3. copy src\embedding\chunker.py .backup\chunker_original.py
4. git checkout -b backup/pre-llm-optimization
5. Optimize files (remove redundant, compress docstrings)
6. Test: python -c "import config; from embedding.chunker import chunk_text_intelligent"
7. git commit -m "optimize: Phase 2 - Content reduction (52% size reduction)"

AFTER:
â”œâ”€â”€ src/config.py (56 lines, -40%)
â”œâ”€â”€ src/embedding/chunker.py (190 lines, -73%)
â””â”€â”€ .backup/ (ignored by git, contains originals)

RESULT: 73% size reduction, 100% functionality preserved
```

## Quality Assurance Checklist

Before committing code, ensure:

- [ ] All imports work correctly (handle optional dependencies)
- [ ] Error cases are handled gracefully
- [ ] Type hints are complete and accurate
- [ ] Docstrings explain purpose and usage
- [ ] Test cases cover both success and failure scenarios
- [ ] Vietnamese text handling works correctly
- [ ] Performance is acceptable for expected usage
- [ ] Memory usage is reasonable
- [ ] Integration with other modules works smoothly

## Thá»­ nghiá»‡m code vá»›i sandbox

Náº¿u file gáº·p nhiá»u lá»—i thÃ¬ cÃ³ thá»ƒ thá»­ nghiá»‡m trong `tests/sandbox` sau Ä‘Ã³ merge code vÃ o.

- Thá»­ nghiá»‡m xong pháº£i xÃ³a file trong sandbox.

## Git Branching hiá»‡u quáº£

- **master**: production

- **develop**: tÃ­ch há»£p cÃ¡c tÃ­nh nÄƒng

- **feature/**: phÃ¡t triá»ƒn tÃ­nh nÄƒng

- **release/**: chuáº©n bá»‹ phÃ¡t hÃ nh

- **hotfix/**: sá»­a lá»—i kháº©n cáº¥p
  VÃ­ dá»¥ máº«u:

```mermaid
gitGraph
    commit id: "Initial Project"

    branch develop
    checkout develop
    commit id: "Setup MCP Server"
    commit id: "Add Embedding Manager"

    branch feature/vietnamese-text
    checkout feature/vietnamese-text
    commit id: "Vietnamese Chunker"
    commit id: "Text Processing"

    checkout develop
    merge feature/vietnamese-text
    commit id: "Merge Vietnamese Support"

    branch feature/batch-processing
    checkout feature/batch-processing
    commit id: "Batch Processor"
    commit id: "Memory Optimization"
    commit id: "Performance Metrics"

    checkout develop
    merge feature/batch-processing
    commit id: "Merge Batch Processing"

    branch master
    checkout master
    commit id: "Production v1.0"

    checkout develop
    commit id: "Error Handling"
    commit id: "Input Validation"

    branch hotfix/fix-psutil-import
    checkout hotfix/fix-psutil-import
    commit id: "Fix psutil import error"
    commit id: "Resolve conflicts"
    commit id: "Update .gitignore"

    checkout master
    merge hotfix/fix-psutil-import
    commit id: "Hotfix Applied"

    checkout develop
    merge master
    commit id: "Sync with Master"

    branch feature/security-enhancements
    checkout feature/security-enhancements
    commit id: "Security Validation"
    commit id: "Audit Logging"

    checkout develop
    branch release/v2.0
    checkout release/v2.0
    commit id: "Prepare Release"
    commit id: "Documentation"
    commit id: "Final Testing"

    checkout master
    merge release/v2.0
    commit id: "Production v2.0"

    checkout develop
    merge release/v2.0
    commit id: "Release Merged Back"

```

## Backup Directory Management

### **Setup Backup Infrastructure**
```powershell
# Táº¡o backup directory structure
mkdir -p .backup
echo ".backup/" >> .gitignore

# Backup before major changes
copy important_file.py .backup\important_file_original.py
copy another_file.py .backup\another_file_YYYYMMDD.py
```

### **Best Practices for Backup Directory**
1. **Always ignore .backup in git** - Backup files lÃ  local safety net
2. **Use descriptive backup names** - include date vÃ  purpose
3. **Keep backups until stability confirmed** - Äá»«ng xÃ³a too early
4. **Combine vá»›i git backup branches** - Double safety cho major changes
5. **Backup entire directories** cho large refactoring projects

### **Backup Naming Conventions**
```
.backup/
â”œâ”€â”€ config_original.py          # Original version
â”œâ”€â”€ config_phase1.py            # After phase 1 changes  
â”œâ”€â”€ chunker_original.py         # Before optimization
â”œâ”€â”€ chunker_20250618.py         # Timestamped backup
â””â”€â”€ src_backup/                 # Full directory backup
    â””â”€â”€ [entire src structure]
```

## Dependencies Management
**Only using `uv` for Python package and project manager.**

