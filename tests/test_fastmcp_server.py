# Generated by Copilot
"""
Test script for FastMCP server implementation
Kiá»ƒm thá»­ server má»›i vá»›i FastMCP library
"""

import sys
import os
import logging
import asyncio
from typing import Dict, Any

# Add project root to path for imports
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
sys.path.insert(0, project_root)

# Setup logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def test_fastmcp_imports():
    """Test táº¥t cáº£ imports cáº§n thiáº¿t cho FastMCP server"""
    print("ğŸ§ª Testing FastMCP Server Imports")
    print("=" * 50)
    
    try:
        # Test FastMCP import
        from mcp.server.fastmcp import FastMCP
        print("âœ… FastMCP import successful")
        
        # Test ChromaDB import  
        import chromadb
        print("âœ… ChromaDB import successful")
        
        # Test embedding components
        from src.embedding.manager import EmbeddingManager
        from src.embedding.auth import HuggingFaceAuth
        print("âœ… Embedding components import successful")
        
        # Test server module
        import src.server_fastmcp as server_module
        print("âœ… FastMCP server module import successful")
        
        print("\nğŸ‰ All imports successful!")
        return True
        
    except Exception as e:
        print(f"âŒ Import failed: {e}")
        logger.exception("Import test failed")
        return False

def test_fastmcp_server_initialization():
    """Test khá»Ÿi táº¡o FastMCP server"""
    print("\nğŸš€ Testing FastMCP Server Initialization")
    print("=" * 50)
    
    try:
        # Import server components
        from src.server_fastmcp import get_chroma_client, get_embedding_manager
        
        # Test ChromaDB client
        print("ğŸ”§ Testing ChromaDB client...")
        client = get_chroma_client()
        print(f"âœ… ChromaDB client initialized: {type(client)}")
        
        # Test collections
        collections = client.list_collections()
        print(f"ğŸ“ Current collections: {len(collections)}")
        
        # Test embedding manager
        print("ğŸ§  Testing embedding manager...")
        embedding_manager = get_embedding_manager()
        print(f"âœ… Embedding manager initialized: {type(embedding_manager)}")
        
        # Test model info
        model_info = embedding_manager.get_model_info()
        print(f"ğŸ¤– Current model: {model_info}")
        
        print("\nğŸ‰ Server initialization successful!")
        return True
        
    except Exception as e:
        print(f"âŒ Initialization failed: {e}")
        logger.exception("Initialization test failed")
        return False

def test_fastmcp_tools_definition():
    """Test definition cá»§a cÃ¡c MCP tools"""
    print("\nğŸ› ï¸ Testing FastMCP Tools Definition")
    print("=" * 50)
    
    try:
        # Import server Ä‘á»ƒ load tools
        from src.server_fastmcp import mcp
        
        # Check tools Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a
        print("ğŸ” Checking defined tools...")
        
        # Láº¥y danh sÃ¡ch tools (náº¿u FastMCP cÃ³ method nÃ y)
        tools_info = []
        if hasattr(mcp, '_tools') or hasattr(mcp, 'tools'):
            tools = getattr(mcp, '_tools', getattr(mcp, 'tools', {}))
            for tool_name in tools:
                tools_info.append(tool_name)
                print(f"   âœ… {tool_name}")
        
        if tools_info:
            print(f"\nğŸ“Š Total tools defined: {len(tools_info)}")
            print(f"ğŸ¯ Tools: {', '.join(tools_info)}")
        else:
            print("âš ï¸ Unable to introspect tools (this might be normal)")
            
        print("\nğŸ‰ Tools definition check completed!")
        return True
        
    except Exception as e:
        print(f"âŒ Tools definition test failed: {e}")
        logger.exception("Tools definition test failed")
        return False

async def test_fastmcp_tool_execution():
    """Test thá»±c thi cÃ¡c tools cÆ¡ báº£n"""
    print("\nâš¡ Testing FastMCP Tool Execution")
    print("=" * 50)
    
    try:
        # Import cÃ¡c tool functions
        from src.server_fastmcp import (
            echo, list_collections, create_collection, 
            get_embedding_model_info, chunk_text_intelligent
        )
        
        # Test echo tool
        print("ğŸ“¢ Testing echo tool...")
        echo_result = await echo("Hello FastMCP!")
        print(f"   Result: {echo_result}")
        
        # Test list collections
        print("ğŸ“ Testing list collections...")
        collections = await list_collections()
        print(f"   Collections: {collections}")
        
        # Test embedding model info
        print("ğŸ¤– Testing embedding model info...")
        model_info = await get_embedding_model_info()
        print(f"   Model: {model_info}")
        
        # Test intelligent chunking
        print("ğŸ§© Testing intelligent chunking...")
        test_text = "ÄÃ¢y lÃ  vÄƒn báº£n tiáº¿ng Viá»‡t Ä‘á»ƒ test chunking. ChÃºng ta sáº½ chia nÃ³ thÃ nh cÃ¡c pháº§n nhá» hÆ¡n."
        chunks = await chunk_text_intelligent(test_text, chunk_size=50, overlap=10)
        print(f"   Chunks: {len(chunks)}")
        for i, chunk in enumerate(chunks):
            print(f"      {i+1}: {chunk[:50]}...")
        
        # Test create collection
        print("ğŸ“ Testing create collection...")
        test_collection_name = "fastmcp_test_collection"
        
        # Delete if exists
        try:
            from src.server_fastmcp import delete_collection
            await delete_collection(test_collection_name)
        except:
            pass
            
        create_result = await create_collection(
            test_collection_name, 
            metadata={"test": True, "created_by": "fastmcp_test"}
        )
        print(f"   Result: {create_result}")
        
        # Verify collection was created
        collections_after = await list_collections()
        if test_collection_name in collections_after:
            print(f"   âœ… Collection '{test_collection_name}' created successfully")
        else:
            print(f"   âŒ Collection '{test_collection_name}' not found")
        
        print("\nğŸ‰ Tool execution tests completed!")
        return True
        
    except Exception as e:
        print(f"âŒ Tool execution test failed: {e}")
        logger.exception("Tool execution test failed")
        return False

async def test_fastmcp_document_operations():
    """Test cÃ¡c operations vá»›i documents"""
    print("\nğŸ“ Testing FastMCP Document Operations")
    print("=" * 50)
    
    try:
        from src.server_fastmcp import (
            add_documents, query_collection, create_collection, list_collections
        )
        
        collection_name = "fastmcp_doc_test"
        
        # Táº¡o collection
        print(f"ğŸ“ Creating test collection: {collection_name}")
        await create_collection(collection_name, metadata={"purpose": "document_test"})
        
        # Add documents
        print("ğŸ“ Adding test documents...")
        test_docs = [
            "CÃ´ng nghá»‡ AI Ä‘ang phÃ¡t triá»ƒn ráº¥t nhanh á»Ÿ Viá»‡t Nam",
            "VinAI Research táº¡o ra nhiá»u breakthrough trong NLP",
            "Blockchain vÃ  cryptocurrency Ä‘Æ°á»£c quan tÃ¢m nhiá»u", 
            "Fintech Viá»‡t Nam cÃ³ MoMo, ZaloPay ráº¥t thÃ nh cÃ´ng"
        ]
        
        add_result = await add_documents(
            collection_name=collection_name,
            documents=test_docs,
            ids=[f"doc_{i}" for i in range(len(test_docs))],
            metadatas=[
                {"category": "ai", "index": 0},
                {"category": "ai", "index": 1}, 
                {"category": "blockchain", "index": 2},
                {"category": "fintech", "index": 3}
            ]
        )
        print(f"   Add result: {add_result}")
        
        # Query documents
        print("ğŸ” Testing semantic search...")
        queries = [
            "trÃ­ tuá»‡ nhÃ¢n táº¡o",
            "thanh toÃ¡n Ä‘iá»‡n tá»­", 
            "cryptocurrency"
        ]
        
        for query in queries:
            print(f"\n   Query: '{query}'")
            results = await query_collection(
                collection_name=collection_name,
                query_texts=[query],
                n_results=2
            )
            
            if results and 'documents' in results and results['documents'][0]:
                for i, (doc, distance) in enumerate(zip(results['documents'][0], results['distances'][0])):
                    print(f"      {i+1}. [{distance:.3f}] {doc[:60]}...")
            else:
                print("      No results found")
        
        print("\nğŸ‰ Document operations tests completed!")
        return True
        
    except Exception as e:
        print(f"âŒ Document operations test failed: {e}")
        logger.exception("Document operations test failed")
        return False

async def run_all_tests():
    """Cháº¡y táº¥t cáº£ tests"""
    print("ğŸ§ª FastMCP Server Comprehensive Test Suite")
    print("=" * 80)
    
    tests = [
        ("Imports", test_fastmcp_imports),
        ("Initialization", test_fastmcp_server_initialization), 
        ("Tools Definition", test_fastmcp_tools_definition),
        ("Tool Execution", test_fastmcp_tool_execution),
        ("Document Operations", test_fastmcp_document_operations)
    ]
    
    results = {}
    
    for test_name, test_func in tests:
        try:
            if asyncio.iscoroutinefunction(test_func):
                result = await test_func()
            else:
                result = test_func()
            results[test_name] = result
        except Exception as e:
            print(f"âŒ {test_name} test crashed: {e}")
            results[test_name] = False
    
    # Summary
    print("\n" + "=" * 80)
    print("ğŸ“Š TEST RESULTS SUMMARY")
    print("=" * 80)
    
    passed = 0
    for test_name, result in results.items():
        status = "âœ… PASS" if result else "âŒ FAIL"
        print(f"   {test_name:20} {status}")
        if result:
            passed += 1
    
    total = len(results)
    print(f"\nğŸ† Overall: {passed}/{total} tests passed ({passed/total*100:.1f}%)")
    
    if passed == total:
        print("ğŸ‰ All tests passed! FastMCP server is ready for use!")
    else:
        print("âš ï¸ Some tests failed. Check logs for details.")
    
    return passed == total

if __name__ == "__main__":
    asyncio.run(run_all_tests())
