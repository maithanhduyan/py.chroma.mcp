#!/usr/bin/env python3
"""
FastMCP ChromaDB Server with Advanced Embedding Integration
Supports ChromaDB, custom embeddings, Vietnamese text processing, and semantic search
Generated by Copilot
"""

import sys
import logging
import time
from typing import Dict, Any, Optional

# Import FastMCP and tools
from tools import mcp

# Configure enhanced logging
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    handlers=[
        logging.StreamHandler(sys.stderr),  # Log to stderr to avoid stdout pollution
    ],
)
logger = logging.getLogger(__name__)

# Ensure UTF-8 encoding for stdout
try:
    if hasattr(sys.stdout, "reconfigure"):
        getattr(sys.stdout, "reconfigure")(encoding="utf-8")
except (AttributeError, TypeError):
    import codecs

    if hasattr(sys.stdout, "buffer"):
        sys.stdout = codecs.getwriter("utf-8")(sys.stdout.buffer)


def log_server_startup():
    """Log server startup information."""
    startup_info = {
        "server": "ChromaDB FastMCP Server",
        "version": "2.0.0",
        "embedding_support": True,
        "vietnamese_support": True,
        "features": [
            "ChromaDB Integration",
            "Custom Embeddings (mixedbread-ai/mxbai-embed-large-v1)",
            "Vietnamese Text Processing",
            "Intelligent Chunking",
            "Semantic Search",
            "Cross-lingual Support",
        ],
        "tools": [
            "echo",
            "list_collections",
            "create_collection",
            "delete_collection",
            "add_documents",
            "query_collection",
            "get_embedding_model_info",
            "configure_embedding_model",
            "chunk_text_intelligent",
        ],
        "startup_time": time.strftime("%Y-%m-%d %H:%M:%S"),
    }

    logger.info("=" * 60)
    logger.info("ğŸš€ FastMCP ChromaDB Server Starting")
    logger.info("=" * 60)
    logger.info(f"ğŸ“‹ Server: {startup_info['server']} v{startup_info['version']}")
    logger.info(f"ğŸ¤– Embedding: mixedbread-ai/mxbai-embed-large-v1")
    logger.info(f"ğŸ‡»ğŸ‡³ Vietnamese: Fully Supported")
    logger.info(f"ğŸ› ï¸ Tools: {len(startup_info['tools'])} available")
    logger.info(f"â° Started: {startup_info['startup_time']}")
    logger.info("=" * 60)


def main():
    """Main server entry point using FastMCP."""
    try:
        # Log startup information
        log_server_startup()

        # Initialize embedding systems
        logger.info("ğŸ”§ Initializing embedding systems...")

        # Import to trigger initialization
        from tools import get_chroma_client, get_embedding_manager

        # Initialize ChromaDB
        chroma_client = get_chroma_client()
        logger.info(f"âœ… ChromaDB initialized: {type(chroma_client).__name__}")

        # Initialize embeddings
        embedding_manager = get_embedding_manager()
        model_info = embedding_manager.get_model_info()
        logger.info(
            f"âœ… Embedding model: {model_info['name']} ({model_info['embedding_dim']}D)"
        )

        logger.info("ğŸ¯ FastMCP server ready for connections")
        logger.info("=" * 60)

        # Run the FastMCP server
        mcp.run()

    except KeyboardInterrupt:
        logger.info("\nğŸ›‘ Server shutdown requested by user")
    except Exception as e:
        logger.error(f"ğŸ’¥ Server startup failed: {e}")
        logger.exception("Server startup error details:")
        sys.exit(1)
    finally:
        logger.info("ğŸ”š FastMCP ChromaDB Server stopped")


if __name__ == "__main__":
    main()
